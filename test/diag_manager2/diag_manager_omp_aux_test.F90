!! \brief Contains a program for testing module fms_diag_omp_aux

! \description
!! Contains a program for testing module fms_diag_omp_aux
program diag_manager_omp_aux_test
    use omp_lib
    use fms_diag_omp_aux, only: get_average, alloc_subarray, num_offloading_threads
    use fms_diag_omp_dummy
    implicit none

    integer, parameter:: dp=kind(0.d0)

    integer(kind = 4) :: num_threads_cpu
    real (dp), allocatable ::  data1D(:)
    real (dp), allocatable ::  data2D(:,:)
    real (dp), allocatable ::  data3D(:,:,:)
    real (dp), allocatable ::  data4D(:,:,:,:)
    real (dp), allocatable ::  data5D(:,:,:,:,:)
    real (dp) ::  average0D, expected1D
    real (dp), dimension(1:5) :: average1D
    real (dp), dimension(1:5, 1:6) :: average2D
    real (dp), dimension(1:5, 1:6, 1:7) :: average3D
    real (dp), dimension(1:5, 1:6, 1:7, 1:8) :: average4D


    real (dp), allocatable :: a_average2D(:,:)
    real (dp), allocatable :: a_average3D(:, :, :)

    integer :: nx,ny,nz,nt, nh, max_nt, target_row
    real (dp) k2, k3, k4, k5

    print *, "Starting OMP_FF program"

    max_nt = 1000
    !!Allocate the larger arrays
    allocate (data1D (max_nt))
    allocate (data2D (5,max_nt))
    allocate (data3D (5,6,max_nt))
    allocate (data4D (5,6,7,max_nt))
    allocate (data5D (5,6,7,8, max_nt))

    !Make some data
    k2 = 2.2d0
    k3 = 3.3_dp
    k4 = 4.4_dp
    k5 = 5.432_dp

    !Initialize more test data
    do nt = 1, max_nt
        data1D(nt) =  nt
        do nx = 1,5
             data2D(nx, nt ) =  nt * k2
            do ny = 1, 6
                data3D(nx, ny, nt ) =  nt * k3
                do nz = 1, 7
                     data4D(nx, ny, nz, nt ) =  nt * k4
                     do nh = 1, 8
                        data5D(nx, ny, nz, nh, nt ) =  nt * k5
                    end do
                end do
            end do
        end do
    end do

    expected1D = sum(data1D) / max_nt

    !! expected 1D ave = (1/max_nt) * [(max_nt) * (max_nt + 1) / 2] == (max_nt+1)/2
    !! expectd 2D SUM ave = (1D ave) (5)(5+1)/2 = (1D ave)*15
    !! 3D >> 1D * 21   4D >> 1D  * 28
    !!

    num_threads_cpu = 4
    call omp_set_num_threads( num_threads_cpu )

    call print_device_info()

    print *, "*** OMP_FF CALLS get_average (1D):"

    call get_average( data1D, average0D, num_threads_cpu)

    print *,"average0D= ",average0D, "expected=",expected1D

    print *, "*** OMP_FF CALLS get_average (2D):"

    call get_average(data2D , average1D, 4)

    !!print *,"average1D(1:2)= ",average1D(1:2)  !! just print the first two

    print *,"sum(average1D)= ",sum(average1D), "expected =",(expected1D * 5* k2 )

    print *, "*** OMP_FF CALLS get_average (3D):"

    call get_average(data3D , average2D, 4)

    !!print *,"average1D(1,1:3)= ",average2D(1,1:3)  !! just print the first three

    print *,"sum(average2D)= ",sum(average2D), "expected =",(expected1D * (6 * 5 ) * k3)

    print *, "*** OMP_FF CALLS get_average (4D):"

    call get_average(data4D , average3D, 4)

    !!print *,"average3D(1,1,1:3)= ",average3D(1,1,1:3)  !! just print the first three

    print *,"sum(average3D)= ",sum(average3D), "expected =", &
        (expected1D * (5 * 6 * 7) * k4 )

    print *, "*** OMP_FF CALLS get_average (5D):"

    call get_average(data5D , average4D, 4)

    !!print *,"average3D(1,1,1:3)= ",average3D(1,1,1:3)  !! just print the first three

    print *,"sum(average4D)= ",sum(average4D), "expected =", &
        (expected1D * (5 * 6 * 7 * 8) * k5 )

    print *, "OMP_FF CALLS get_average_MN:"
    !!target_row = 3
    !!call get_average_MN( data2D, target_row ,average0D,  num_threads_cpu)

    !!print *,"average0D= ",average0D, "expected=",(target_row * expected1D)

    !!print *, "OMP_FF Ave from Matrix column V2"

    !!call get_average_CMXN( data2D, target_row , average0D, 4)

    !!print *,"average0D= ",average0D, "expected=",(target_row * expected1D)

    print *, "OMP_FF CALLS allocating subarrays:"

    print *, "is allocated (a_average2D):", allocated (a_average2D)
    call alloc_subarray(data3D,a_average2D)
    print *, "is allocated (a_average2D):", allocated (a_average2D)
    a_average2D(1,1) = 1.11_dp
    print *,"a_average2D(1,1:3)= ",a_average2D(1,1:3)  !! just print the first three

    print *, "is allocated ? (a_average3D):", allocated (a_average3D)
    call alloc_subarray(data4D, a_average3D)
    print *, "is allocated ? (a_average3D):", allocated (a_average3D)
    a_average3D(1,1,1) = 2.23_dp
    print *,"a_average3D(1,1,1:3)= ",a_average3D(1,1,1:3)  !! just print the first three

end program diag_manager_omp_aux_test

!!TODO convention for index starting array.
!! Array multi dim

 !This is a test subroutine.
    !Prints some info helpful in device offloading
    subroutine print_device_info()
        use omp_lib
        use fms_diag_omp_aux, only: num_offloading_threads
        implicit none

        integer :: num_threads, tid, num_gpu_threads,n_gpu_thread
        logical :: inital_dev

        print *, "In print_device_info()"

        !$opm declare target


         inital_dev = omp_is_initial_device()
         print *, "Post declare target; pre parallel sec., inital_dev=", inital_dev

        !!OMP may be optimizing this for thread zero to thread to repeat
        !$omp parallel private(tid, n_gpu_thread)
            tid = omp_get_thread_num()

            if (tid == 0) then
                num_threads = omp_get_num_threads()
                print *, "Hello from thrd id=", tid
                print *, "In parallel section:"
                print *, "Number of threads available  =", num_threads
                print *, "Number of processors available = ", omp_get_num_procs ( )
                print *, "Max threads available = ", omp_get_max_threads ( )
                print *, "Number of devices = ", omp_get_num_devices()
            else
                n_gpu_thread = num_offloading_threads(num_threads)
                print *, "Hello from thrd id=", tid, "n_gpu_thread=", n_gpu_thread
            end if
        !$omp end parallel

        print *, "Outside parallel section:"
        print *, "Number of threads available=", omp_get_num_threads()
        print *, "Number of devices = ", omp_get_num_devices()

        num_gpu_threads = num_offloading_threads(num_threads)
        if ( num_gpu_threads ==num_threads) then
            print *, "Probably cannot offload?"
        else
            print *, "Probably can offload?"
        endif

        print *, "Leaving print_device_info()"


    end subroutine print_device_info

